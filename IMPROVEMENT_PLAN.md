# アプリケーション堅牢性向上計画

## フェーズ1: セキュリティとエラーハンドリング

### タスク1: シェルインジェクション対策 🚨
**優先度**: 最高

#### 1.1 api.ts の fetchHistory 関数の修正
- [ ] gitコマンド実行時のファイルパスをサニタイズ
- [ ] シェルメタ文字のエスケープ処理を実装
- [ ] execの代わりにchild_process.spawnを使用

#### 1.2 安全なコマンド実行ヘルパーの作成
- [ ] `lib/safeExec.ts` を作成
- [ ] コマンドと引数を分離した実行方式を実装
- [ ] タイムアウト処理を追加

### タスク2: ファイル操作のエラーハンドリング
**優先度**: 高

#### 2.1 api.ts のエラーハンドリング強化
- [ ] fetchSlugs: ディレクトリ読み込みエラーの処理
- [ ] fetchPost: ファイル読み込みエラーとfront-matterパースエラーの処理
- [ ] 適切なエラーメッセージとフォールバック値の設定

#### 2.2 カスタムエラークラスの作成
- [ ] `lib/errors.ts` を作成
- [ ] FileNotFoundError, ParseError などの具体的なエラー型を定義
- [ ] エラーログ出力の統一化

### タスク3: XSS対策の強化
**優先度**: 高

#### 3.1 Markdownレンダリングの安全性向上
- [ ] markdownToHtml.ts で allowDangerousHtml の使用を見直し
- [ ] DOMPurifyなどのサニタイザーの導入を検討
- [ ] ホワイトリスト方式でのHTML要素制限

#### 3.2 ユーザー入力のサニタイズ
- [ ] impressionForm.tsx の入力値検証強化
- [ ] search.tsx の検索クエリサニタイズ
- [ ] URLパラメータの検証処理追加

### タスク4: API呼び出しのエラーハンドリング
**優先度**: 中

#### 4.1 search.tsx の改善
- [ ] ネットワークエラーの処理追加
- [ ] タイムアウト処理の実装
- [ ] リトライロジックの追加

#### 4.2 外部API呼び出しの統一化
- [ ] `lib/apiClient.ts` を作成
- [ ] 共通のエラーハンドリングとロギング
- [ ] レート制限の考慮

## フェーズ2: 型安全性とテスト

### タスク5: TypeScript化と型定義の強化
**優先度**: 高

#### 5.1 JavaScriptファイルのTypeScript化
- [ ] `_app.js` → `_app.tsx` への変換
- [ ] 型定義の追加と修正
- [ ] tsconfig.json で strict モードを有効化

#### 5.2 型安全性の向上
- [ ] api.ts の型ガード実装
- [ ] 外部データ（JSON）の型検証
- [ ] ランタイム型チェックの導入（zod等）

### タスク6: 単体テストの拡充
**優先度**: 高

#### 6.1 api.ts のテスト
- [ ] fetchSlugs のテスト（正常系・異常系）
- [ ] fetchPost のテスト（各種フィールドの組み合わせ）
- [ ] fetchHistory のテスト（gitコマンドのモック）
- [ ] エラーケースのテスト

#### 6.2 エラーハンドリングのテスト
- [ ] ファイルが存在しない場合
- [ ] 不正なMarkdownファイルの場合
- [ ] gitコマンドが失敗した場合

### タスク7: コンポーネントテストの追加
**優先度**: 中

#### 7.1 インタラクティブコンポーネントのテスト
- [ ] impressionForm のユーザー操作テスト
- [ ] search ページの検索機能テスト
- [ ] エラー状態の表示テスト

#### 7.2 Testing Libraryを使用した統合テスト
- [ ] ユーザーシナリオベースのテスト作成
- [ ] アクセシビリティテストの追加

### タスク8: E2Eテストの導入
**優先度**: 中

#### 8.1 Playwrightのセットアップ
- [ ] 基本的なE2Eテスト環境の構築
- [ ] CI/CDパイプラインへの統合

#### 8.2 クリティカルパスのテスト
- [ ] 記事一覧→記事詳細の遷移
- [ ] 検索機能の動作確認
- [ ] 404エラーページの表示

## 実装順序

1. **タスク1**: シェルインジェクション対策（セキュリティ最優先）
2. **タスク2**: ファイル操作のエラーハンドリング
3. **タスク5**: TypeScript化（以降のタスクの基盤）
4. **タスク3**: XSS対策
5. **タスク6**: api.tsのテスト
6. **タスク4**: API呼び出しのエラーハンドリング
7. **タスク7**: コンポーネントテスト
8. **タスク8**: E2Eテスト

## 各タスクの見積もり時間

- タスク1: 2-3時間
- タスク2: 3-4時間
- タスク3: 2-3時間
- タスク4: 2時間
- タスク5: 3-4時間
- タスク6: 4-5時間
- タスク7: 3-4時間
- タスク8: 2-3時間

合計: 約21-31時間

## 成功基準

- [ ] セキュリティ脆弱性がゼロ
- [ ] 全ての外部入力が適切にサニタイズされている
- [ ] エラー発生時にアプリケーションがクラッシュしない
- [ ] TypeScriptのstrictモードでエラーがない
- [ ] テストカバレッジ80%以上
- [ ] E2Eテストが全て成功する